# Production Deployment

This repository now includes a Vercel deployment target and a helper script so you can push the production build with a single command. This document outlines the prerequisites and the steps to deploy the combined Next.js + Express + Turso stack.

## Prerequisites

- Vercel CLI installed (`npm i -g vercel`) and authenticated (`vercel login`).
- A Vercel project (org + project) ready to receive deployments.
- A Turso database with an auth token. Copy the Database URL and auth token from the Turso dashboard.
- Optional: a Postmark server token if you plan to enable transactional emails.

## Environment Variables

Set these variables in Vercel (Project Settings → Environment Variables) **and** in your local shell when running `yarn deploy`:

| Variable | Description |
| --- | --- |
| `TURSO_URL` | Turso database URL, e.g. `libsql://slowpost-username.turso.io`. |
| `TURSO_AUTH_TOKEN` | Turso auth token with read/write access. |
| `TURSO_SYNC_INTERVAL_MS` | *(Optional)* Turso client sync interval in milliseconds. |
| `SKIP_PIN` | Set to `false` in production so PINs are delivered by email instead of returned in responses. |
| `POSTMARK_SERVER_TOKEN` | *(Optional)* Token used when wiring up Postmark email. |
| `POSTMARK_FROM_EMAIL` | *(Optional)* From address used when emailing PINs via Postmark. |
| `VERCEL_ORG_ID` | *(Optional)* Vercel org identifier if you want the CLI to skip prompting. |
| `VERCEL_PROJECT_ID` | *(Optional)* Vercel project identifier. |
| `VERCEL_TOKEN` | *(Optional)* Vercel personal access token for non-interactive deploys. |

The API layer automatically uses Turso whenever `TURSO_URL` and `TURSO_AUTH_TOKEN` are present. Otherwise it falls back to the local SQLite database (useful for local development and tests).

When `POSTMARK_SERVER_TOKEN` and `POSTMARK_FROM_EMAIL` are defined *and* `SKIP_PIN` is **not** set to `true`, login PINs are delivered via Postmark. If either value is missing the server logs a warning and returns the PIN directly (development behaviour).

> **Postmark setup**
> 1. Create a Postmark server and copy the *Server API Token* into `POSTMARK_SERVER_TOKEN`.
> 2. Verify a sending domain or single address in Postmark, then set `POSTMARK_FROM_EMAIL` to that verified address (e.g. `login@yourdomain.com`).
> 3. Leave `SKIP_PIN` unset (or explicitly `false`) in production so the handler emails codes instead of returning them.

## One-Command Deploy

From the repository root run:

```bash
yarn deploy
```

The helper script (`scripts/deploy-to-vercel.js`) now performs two steps:

1. `vercel build --prod` – builds the Next.js client in `packages/client` and the API function declared in `api/index.ts`, producing the `.vercel/output` bundle described by `vercel.json`.
2. `vercel deploy --prod --prebuilt --confirm` – uploads that prebuilt bundle so production matches the locally verified build.

Environment flags (`VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID`) and any extra CLI arguments you pass to `yarn deploy` are forwarded to both commands, so you can run:

```bash
yarn deploy --env production
```

The script exits with the same code as the underlying CLI commands, which makes it safe to use in CI/CD pipelines.

## Vercel Build Configuration

`vercel.json` declares two builders: `@vercel/next` targets the client workspace, and `@vercel/node` bundles the shared server handler. The routes section sends `/api/*` traffic to the Node function while all other paths resolve to the Next.js application under `packages/client`.

At runtime the serverless entry uses the same handler implementations as the Express server (`packages/server/src/api/vercel.ts`). Turso is initialised lazily via dynamic import, so the optional dependency is only required when the Turso credentials are present.

## Local Verification Checklist

Before deploying run:

```bash
yarn workspace @slowpost/server test
corepack yarn workspace @slowpost/client build
corepack yarn workspace @slowpost/client test
```

If you change the API contract, update the Storybook/Vitest suites in `packages/client` as usual so the autogenerated tests remain in sync.

Once the above tests pass and the required environment variables are configured, `yarn deploy` will push a production build to Vercel.
